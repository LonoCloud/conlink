# A docker-compose file with an external network configuration file
# and two docker containers that are connected via a switch. In
# addition an "internet" host is setup in the network container that
# is also connected to the switch and is listening on 8.8.8.8.

version: "2.4"

services:
  network:
    build: {context: ../}
    image: conlink
    pid: host
    network_mode: none
    cap_add: [SYS_ADMIN, NET_ADMIN, SYS_NICE, NET_BROADCAST, IPC_LOCK]
    security_opt: [ 'apparmor:unconfined' ] # needed on Ubuntu 18.04
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker:/var/lib/docker
      - ./:/test
    command: /sbin/conlink --compose-file /test/test2-compose.yaml --network-file /test/test2-network.yaml

  node1:
    image: alpine
    cap_add: [NET_ADMIN]
    network_mode: none
    command: sleep 864000

  node2:
    image: alpine
    cap_add: [NET_ADMIN]
    network_mode: none
    command: sh -c 'while ! ip link show eth0 up; do sleep 1; done; sleep 864000'
